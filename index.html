<!DOCTYPE html>
<html>

<head>
    <title>Car-CAS Simulator</title>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;

        }

        canvas {
            background-color: gray;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
    </style>

</head>

<body>
    <div class="fixed text-black max-w-md w-full p-6">
        <p class="text-white text-xs p-1">This simulator is a part of group 29's project for CS2066 V.1.1</p>
        <button class="bg-green-500 text-white font-bold rounded" id="resetbutton" onclick="ResetCanvas()"
            style="width: 50px; height: 60px;">Reset</button>
        <button class="bg-red-500 text-white font-bold rounded" id="runbutton" onclick="RunClick()"
            style="width: 50px; height: 60px;">Run</button>
    </div>
    <div class="fixed inset-0 flex items-center justify-center" id="infocard" style="display: none;">
        <div class="bg-white max-w-md w-full p-6">
            <form id="myForm" onsubmit="return false">
                <h2 class="text-3xl font-bold">Add New Vehicle</h2>
                <!-- <p class="text-s py-2">Give infor</p> -->
                <div class="text-s py-1">
                    <label for="velocity">Velocity (0-25):</label>
                    <input class="" type="number" id="v_in" name="velocity">
                </div>
                <div class="text-s py-1">
                    <label for="direction">Direction (0-360 degree):</label>
                    <input class="" type="number" id="d_in" name="direction">
                </div>
                <br>
                <div> <input type="submit" class="bg-blue-500 text-white font-bold w-full rounded-full py-3"
                        id="saveinfo" value="Submit"> </div>
            </form>
        </div>
    </div>
    <canvas id="playground"></canvas>

    <script>
        var form = document.getElementById("myForm");
        function handleForm(event) { event.preventDefault(); }
        const runbutton = document.getElementById("runbutton");
        const infocard = document.getElementById('infocard');
        const savebutton = document.getElementById('saveinfo');
        const canvas = document.getElementById('playground');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        window.addEventListener("resize", function () {
            canvas.setAttribute("width", window.innerWidth);
            canvas.setAttribute("height", window.innerHeight)
            ctx.clearRect(0, 0, canvas.width, canvas.height)

            for (let i = 0; i < Cars.length; i++) {
                Cars[i].draw_radar();
            }
            for (let i = 0; i < Cars.length; i++) {
                Cars[i].draw_circle();
            }
            for (let i = 0; i < Cars.length; i++) {
                Cars[i].draw_direction();
            }
            if (isPlaying) { requestAnimationFrame(Update); }
        })

        const ctx = canvas.getContext('2d');
        var isPlaying = false;
        var numberofcar = 0;
        let radar_lenght = 200;
        let car_r = 15;
        function Car(x, y, r, colour, v, d) {
            numberofcar++;
            this.id = numberofcar
            this.x = x;
            this.y = y;
            this.r = r;
            this.status = "running" //"crashed" "emergency" "out" "stop"
            this.colour = colour

            this.v = v; //velocity
            this.d = d; //degree direction

            this.dd = 10;//diff degree direction
            this.a = -0.2; //acceleration

            this.draw_radar = function () {
                var colour_radar;
                if (this.status == "running") {
                    colour_radar = "green";
                } else if (this.status == "emergency") {
                    colour_radar = "red";
                } else if (this.status == "stop") {
                    colour_radar = "yellow";
                } else {
                    colour_radar = "black";
                }

                ctx.beginPath();
                ctx.fillStyle = colour_radar;
                ctx.arc(this.x, this.y, radar_lenght, 0, Math.PI * 2);
                ctx.fill();

            }
            this.draw_circle = function () {
                ctx.beginPath();
                ctx.fillStyle = this.colour;
                ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
                ctx.fill();

            }
            this.draw_direction = function () {
                let dx = Math.cos(2 * Math.PI * (-this.d / 360)) * this.v
                let dy = Math.sin(2 * Math.PI * (-this.d / 360)) * this.v
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.strokeStyle = 'purple';
                ctx.lineTo(this.x + (dx * 5), this.y + (dy * 5));
                ctx.stroke();
            }

            this.animate = function () {

                if (this.status == 'running' || this.status == 'emergency') {

                    if (this.status == 'emergency') {
                        if (this.v > 0) {
                            this.v += this.a;
                            this.d += this.dd;
                        } else if (this.v <= 0) {
                            this.v = 0;
                            this.status = 'stop'
                        }
                    }
                    if (this.status == 'running' || this.status == 'emergency') {
                        Cars.forEach(element => {
                            if (this != element) {
                                let distance = Math.sqrt(Math.pow(this.x - element.x, 2) + Math.pow(this.y - element.y, 2))
                                if (distance < car_r * 2.05) {
                                    this.status = 'crashed';
                                    element.status = 'crashed';
                                }
                                else if (distance < radar_lenght && this.status != 'crashed') {
                                    this.status = 'emergency';
                                }
                            }
                        });
                    }

                    let dx = Math.cos(2 * Math.PI * (-this.d / 360)) * this.v
                    let dy = Math.sin(2 * Math.PI * (-this.d / 360)) * this.v
                    this.x += dx;
                    this.y += dy;

                    if (this.x + this.r > canvas.width || this.x - this.r < 0) {
                        this.status = 'out';
                    }
                    if (this.y + this.r > canvas.height || this.y - this.r < 0) {
                        this.status = 'out';
                    }
                }

                // this.draw_radar();
                // this.draw_circle();
                // this.draw_direction();
            }
        }
        var Cars = [];
        // for (let i = 0; i < 10; i++) {
        //     let r = Math.floor(Math.random() * 30) + 15;
        //     let x = Math.random() * (canvas.width - r * 2) + r;
        //     let y = Math.random() * (canvas.height - r * 2) + r;
        //     let colour = 'red'
        //     Cars.push(new Car(x, y, r, colour, 3, Math.floor(Math.random() * 360)))
        // }

        canvas.addEventListener('click', function (e) {
            if (isPlaying == false && (e.clientX + car_r < canvas.width && e.clientX - car_r > 0) && (e.clientY + car_r < canvas.height && e.clientY - car_r > 0)) {
                infocard.style.display = '';
                Cars.push(new Car(e.clientX, e.clientY, car_r, 'blue', 0, 0))
                Cars[Cars.length - 1].draw_circle();
            }
        });

        function Update() {
            ctx.clearRect(0, 0, canvas.width, canvas.height)

            for (let i = 0; i < Cars.length; i++) {
                Cars[i].animate();
            }
            for (let i = 0; i < Cars.length; i++) {
                Cars[i].draw_radar();
            }
            for (let i = 0; i < Cars.length; i++) {
                Cars[i].draw_circle();
            }
            for (let i = 0; i < Cars.length; i++) {
                Cars[i].draw_direction();
            }
            if (isPlaying) { requestAnimationFrame(Update); }

        }


        // function SaveInfo() {
        //     infocard.style.display = 'none';
        //     Cars[Cars.length - 1].draw();
        // }
        form.addEventListener('submit', function () {
            if (document.getElementById("v_in").value != "" && document.getElementById("d_in").value != "") {
                infocard.style.display = 'none';
                Cars[Cars.length - 1].v = parseFloat(document.getElementById("v_in").value);
                Cars[Cars.length - 1].d = parseFloat(document.getElementById("d_in").value);
                document.getElementById("v_in").value = ""
                document.getElementById("d_in").value = ""
                Cars[Cars.length - 1].draw_radar();
                Cars[Cars.length - 1].draw_circle();
                Cars[Cars.length - 1].draw_direction();
            }
        });

        function RunClick() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                runbutton.innerHTML = "Stop";
                Update();
            }
            else {
                runbutton.innerHTML = "Run";
            }


        }
        function ResetCanvas() {
            Cars = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            isPlaying = true
            RunClick()
        }
        Update();

    </script>
</body>

</html>